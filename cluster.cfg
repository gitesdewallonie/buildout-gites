[buildout]
extends =
    base.cfg
    versions_prod.cfg

versions = versions

#develop =

parts +=
    instance01
    instance02
    supervisor
    libevent
    memcached
    libmemcached
    pound-build
    pound
    varnish-build
    varnish
    varnish-conf
    supervisord-conf
    pound-conf
    logrotate.conf
    sleep

[libevent]
recipe = zc.recipe.cmmi
url = http://www.monkey.org/~provos/libevent-1.4.13-stable.tar.gz

[memcached]
recipe = zc.recipe.cmmi
url = http://memcached.googlecode.com/files/memcached-1.4.13.tar.gz
extra_options = --with-libevent=${libevent:location} --bindir=${buildout:directory}/bin
environment =
    CFLAGS=-I${libevent:location}/include
    LDFLAGS=-L${libevent:location}/lib

[libmemcached]
recipe = zc.recipe.cmmi
url = http://download.tangent.org/libmemcached-0.35.tar.gz
extra_options = --with-memcached=${buildout:directory}/bin/memcached

[instance01]
recipe = plone.recipe.zope2instance
zope2-location = ${zope2:location}
debug-mode = off
verbose-security = off
zeo-client = True
zeo-address = ${zeo:zeo-address}
effective-user = plone
user = admin:admin
http-address = 0.0.0.0:5011
zserver-threads = 2
environment-vars =
    PTS_LANGUAGES fr en nl it de
eggs =
    ${buildout:eggs}
    zope.component
    zope.interface
    zope.app.pagetemplate
    Plone
    lovely.memcached
    zope.ramcache
    Products.MemcachedManager
zcml = ${buildout:zcml}
       gites.core-overrides
products = ${buildout:products}
zodb-cache-size = 8000
zeo-client-cache-size = 100MB
zcml-additional =
 <configure xmlns="http://namespaces.zope.org/zope"
            xmlns:passmgr="http://affinitic.be/passmgr">
    <passmgr:pwdfile name="pg"
             filename="pgpass"/>
 </configure>

[instance02]
recipe = ${instance01:recipe}
zope2-location = ${zope2:location}
debug-mode = ${instance01:debug-mode}
verbose-security = ${instance01:verbose-security}
environment-vars = ${instance01:environment-vars}
zeo-client = ${instance01:zeo-client}
zeo-address = ${instance01:zeo-address}
effective-user = ${instance01:effective-user}
user = ${instance01:user}
http-address = 0.0.0.0:5012
zserver-threads = ${instance01:zserver-threads}
eggs = ${instance01:eggs}
zcml = ${instance01:zcml}
products = ${instance01:products}
zodb-cache-size = ${instance01:zodb-cache-size}
zeo-client-cache-size = ${instance01:zeo-client-cache-size}
zcml-additional = ${instance01:zcml-additional}

[pound-build]
recipe = plone.recipe.pound:build
url = http://www.apsis.ch/pound/Pound-2.6.tgz

[pound]
recipe = plone.recipe.pound:config
daemon = 1
timeout = 160000
balancers =
    ArsiaCerise 0.0.0.0:5009 127.0.0.1:5011 127.0.0.1:5012$

[supervisor]
recipe = collective.recipe.supervisor
programs =
    5 memcached ${buildout:directory}/bin/memcached ${buildout:directory}
    10 zeo ${zeo:location}/bin/runzeo ${zeo:location}
    20 instance01 ${instance01:location}/bin/sleep [30 ${instance01:location}/bin/runzope] ${instance01:location}
    30 instance02 ${instance02:location}/bin/sleep [60 ${instance02:location}/bin/runzope] ${instance02:location}
    50 varnish ${buildout:directory}/bin/varnish ${buildout:directory}
    60 pound ${buildout:directory}/parts/pound-build/sbin/pound -f ${buildout:directory}/etc/pound.conf -p ${buildout:directory}/var/pound.pid
supervisord-conf = ${buildout:directory}/etc/supervisord.conf

[varnish-build]
recipe = plone.recipe.varnish:build
url=http://repo.varnish-cache.org/source/varnish-2.1.5.tar.gz

[varnish]
recipe = plone.recipe.varnish:instance
bind = 0.0.0.0:5000
telnet = 127.0.0.1:5001
cache-size = 200M
mode = foreground
config = ${buildout:directory}/etc/varnish.vcl

[zeo]
recipe = plone.recipe.zope2zeoserver
zope2-location = ${zope2:location}
zeo-address = 0.0.0.0:5010
zeo-conf-additional = 
#eggs = 
#    plone.app.blob

[supervisord-conf]
recipe = collective.recipe.template
input = templates/supervisord.conf
output = ${buildout:directory}/etc/supervisord.conf

[pound-conf]
recipe = collective.recipe.template
input = templates/pound.cfg
output = ${buildout:directory}/etc/pound.cfg

[varnish-conf]
recipe = collective.recipe.template
input = templates/varnish.vcl
output = ${buildout:directory}/etc/varnish.vcl
backend_host = 127.0.0.1
backend_port = 5009

[sleep]
recipe = zc.recipe.egg
eggs = zc.recipe.egg
initialization =
    import sys, time
    time.sleep(float(sys.argv[1]))
arguments = sys.argv[2], sys.argv[2:]
entry-points = sleep=os:execvp

[logrotate.conf]
recipe = zc.recipe.deployment:configuration
text =
    rotate 360
    daily
    create
    compress
    delaycompress
    dateext

    ${buildout:directory}/var/log/instance01*.log {
        sharedscripts
        postrotate
            /bin/kill -USR2 $(cat ${buildout:directory}/var/instance01.pid)
        endscript
    }

    ${buildout:directory}/var/log/instance02*.log {
        sharedscripts
        postrotate
            /bin/kill -USR2 $(cat ${buildout:directory}/var/instance02.pid)
        endscript
    }

    ${buildout:directory}/var/log/zeo.log {
        postrotate
            /bin/kill -USR2 $(cat ${buildout:directory}/var/zeo.pid)
        endscript
    }
